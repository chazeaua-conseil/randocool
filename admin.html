<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nouvelle Marche | Randocool</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #27ae60; --bg: #f8fafc; --dark: #1e293b; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); padding: 20px; color: var(--dark); }
        .form-container { max-width: 800px; margin: 0 auto; background: white; padding: 35px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        h1 { font-weight: 800; color: var(--primary); border-bottom: 2px solid #f1f5f9; padding-bottom: 15px; margin-bottom: 30px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full { grid-column: span 2; }
        label { display: block; font-weight: 700; font-size: 0.85rem; margin-bottom: 8px; color: #64748b; text-transform: uppercase; }
        input, textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; font-family: inherit; box-sizing: border-box; }
        .participants-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(230px, 1fr)); 
            gap: 12px; background: #f8fafc; padding: 20px; border-radius: 16px; margin-top: 10px;
        }
        .member-item { display: flex; align-items: center; gap: 10px; background: white; padding: 10px; border-radius: 10px; border: 1px solid #edf2f7; }
        .btn-submit { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 15px; font-weight: 800; cursor: pointer; margin-top: 30px; }
    </style>
</head>
<body>

<div class="form-container">
    <h1>üèîÔ∏è Enregistrer une marche</h1>
    <form id="marche-form">
        <div class="grid">
            <div class="form-group full">
                <label>Titre de la randonn√©e</label>
                <input type="text" id="titre" required>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="date" required>
            </div>
            <div class="form-group">
                <label>D√©nivel√© (m)</label>
                <input type="number" id="denivele">
            </div>
            <div class="form-group">
                <label>Distance Normale (km)</label>
                <input type="number" step="0.1" id="distance" required>
            </div>
            <div class="form-group">
                <label>Distance "Petit Parcours" (km)</label>
                <input type="number" step="0.1" id="small_distance">
            </div>
            <div class="form-group">
                <label>Lien Image Couverture (image_url)</label>
                <input type="url" id="image_url" placeholder="https://...">
            </div>
            <div class="form-group">
                <label>Lien Album Photos (album_url)</label>
                <input type="url" id="album_url" placeholder="Lien Google Photos">
            </div>
            <div class="form-group full">
                <label>R√©cit / Description</label>
                <textarea id="description" rows="3"></textarea>
            </div>
        </div>

        <h3 style="margin-top:30px; font-size: 1rem;">Participants</h3>
        <div id="participants-list" class="participants-grid">
            <p>Chargement des membres...</p>
        </div>

        <button type="submit" class="btn-submit">PUBLIER ET CR√âDITER LES KM</button>
    </form>
</div>

<script>
        const SUPABASE_URL = 'https://mdpzwevznroqkpnobbag.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kcHp3ZXZ6bnJvcWtwbm9iYmFnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3OTM1MjEsImV4cCI6MjA4NDM2OTUyMX0.ISXEl1Lf-jKMW1BUKnu02wcjs1veZ9Os9kmJcJCmwG4';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function chargerMembres() {
        const { data: membres } = await supabaseClient.from('randocooleurs').select('id, nom').order('nom');
        const list = document.getElementById('participants-list');
        if (membres) {
            list.innerHTML = membres.map(m => `
                <div class="member-item">
                    <input type="checkbox" class="is-present" data-id="${m.id}">
                    <span style="flex:1; font-size:0.85rem; font-weight:600;">${m.nom}</span>
                    <label style="font-size:0.65rem; color:var(--primary); font-weight:800;">
                        <input type="checkbox" class="is-small" data-id="${m.id}"> PETIT
                    </label>
                </div>
            `).join('');
        }
    }

    document.getElementById('marche-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // R√©cup√©ration des valeurs num√©riques
        const dNormale = parseFloat(document.getElementById('distance').value) || 0;
        const dPetite = parseFloat(document.getElementById('small_distance').value || 0);

        // A. Cr√©ation dans la table 'randos'
        const { data: marche, error: mErr } = await supabaseClient.from('randos').insert([{
            titre: document.getElementById('titre').value,
            date: document.getElementById('date').value,
            distance: dNormale,
            small_distance: dPetite,
            denivele: parseInt(document.getElementById('denivele').value || 0),
            description: document.getElementById('description').value,
            image_url: document.getElementById('image_url').value,
            album_url: document.getElementById('album_url').value
        }]).select();

        if (mErr) {
            console.error(mErr);
            alert("Erreur Supabase : " + mErr.message);
            return;
        }

        const marcheId = marche[0].id;
        const presents = document.querySelectorAll('.is-present:checked');

        // B. Traitement des participations et mise √† jour des KM
        for (let p of presents) {
            const membreId = p.dataset.id;
            const aFaitPetit = document.querySelector(`.is-small[data-id="${membreId}"]`).checked;
            const kmGagnes = aFaitPetit ? dPetite : dNormale;

            // 1. Log participation
            await supabaseClient.from('participations').insert([{
                marche_id: marcheId,
                membre_id: membreId,
                a_fait_petit_parcours: aFaitPetit
            }]);

            // 2. Mise √† jour compteur membre
            const { data: mData } = await supabaseClient.from('randocooleurs').select('km').eq('id', membreId).single();
            const nouveauTotal = (parseFloat(mData.km) || 0) + kmGagnes;

            await supabaseClient.from('randocooleurs').update({ km: nouveauTotal }).eq('id', membreId);
        }

        alert("Succ√®s ! La marche et les compteurs kilom√©triques ont √©t√© mis √† jour.");
        window.location.reload();
    });

    chargerMembres();
</script>
</body>
</html>